#!/usr/bin/env bash
set -e

echo "==============================================="
echo "         Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ TELEGRAM WOL BOT"
echo "==============================================="
echo

# ðŸ”¹ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ, Ð¿Ð¾Ð´ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ
USER_NAME=$(whoami)
HOME_DIR=$(getent passwd "$USER_NAME" | cut -d: -f6)

BOT_DIR="$HOME_DIR/wol_bot"
DATA_DIR="$HOME_DIR/wol_bot_data"
ENV_FILE="$BOT_DIR/.env"

echo "Ð‘Ð¾Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð²: $BOT_DIR"
echo "Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð±ÑƒÐ´ÑƒÑ‚ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒÑÑ Ð²: $DATA_DIR"
echo

# ðŸ”¹ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ IP (Ð‘Ð•Ð— Ð·Ð°Ð²Ð¸ÑÐ°Ð½Ð¸Ñ Ð¸ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°Ñ)
valid_ip() {
    local ip=$1
    [[ $ip =~ ^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$ ]]
}

ask_ip() {
    local input
    while true; do
        read -rp "$1: " input
        if valid_ip "$input"; then
            echo "$input"
            return
        else
            echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ IP, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
        fi
    done
}

# ðŸ”¹ Ð’Ð²Ð¾Ð´ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²
read -rp "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Telegram Bot Token: " BOT_TOKEN
read -rp "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Telegram User ID: " USER_ID
OMV_IP=$(ask_ip "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ IP OMV ÑÐµÑ€Ð²ÐµÑ€Ð°")
ROUTER_IP=$(ask_ip "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ IP Ñ€Ð¾ÑƒÑ‚ÐµÑ€Ð° OpenWrt")

# ðŸ”¹ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
mkdir -p "$BOT_DIR"
mkdir -p "$DATA_DIR"

# ðŸ”¹ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
sudo apt update -y
sudo apt install -y python3 python3-pip python3-venv git

# ðŸ”¹ ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ²ÐµÐ¶ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
if [[ -d "$BOT_DIR/.git" ]]; then
    echo "ÐžÐ±Ð½Ð¾Ð²Ð»ÑÑŽ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹..."
    git -C "$BOT_DIR" pull
else
    git clone --depth 1 https://github.com/m33ph/wol_bot.git "$BOT_DIR"
fi

# ðŸ”¹ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
python3 -m venv "$BOT_DIR/venv"
source "$BOT_DIR/venv/bin/activate"
pip install -r "$BOT_DIR/requirements.txt"

# ðŸ”¹ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .env
cat > "$ENV_FILE" <<EOF
WOL_BOT_TOKEN="$BOT_TOKEN"
WOL_ALLOWED_USERS="$USER_ID"
WOL_SERVER_IP="$OMV_IP"
ROUTER_IP="$ROUTER_IP"
DATA_DIR="$DATA_DIR"
EOF

# ðŸ”¹ Systemd service
SERVICE_FILE="/etc/systemd/system/wolbot.service"
sudo bash -c "cat > $SERVICE_FILE" <<EOF
[Unit]
Description=Telegram WOL Bot
After=network.target

[Service]
WorkingDirectory=$BOT_DIR
ExecStart=$BOT_DIR/venv/bin/python3 $BOT_DIR/wol_bot.py
Restart=always
User=$USER_NAME
EnvironmentFile=$ENV_FILE

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable wolbot.service
sudo systemctl restart wolbot.service

echo
echo "==============================================="
echo "          Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐ!"
echo "Ð‘Ð¾Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚: systemctl status wolbot"
echo "==============================================="
